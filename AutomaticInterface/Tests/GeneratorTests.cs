using System;
using System.Linq;
using AutomaticInterface;
using FluentAssertions;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Xunit;

namespace Tests;

public class GeneratorTests
{
    private static string GenerateCode(string code)
    {
        var syntaxTree = CSharpSyntaxTree.ParseText(code);
        var references = AppDomain
            .CurrentDomain.GetAssemblies()
            .Where(assembly => !assembly.IsDynamic)
            .Select(assembly => MetadataReference.CreateFromFile(assembly.Location))
            .Cast<MetadataReference>();

        var compilation = CSharpCompilation.Create(
            "SourceGeneratorTests",
            new[] { syntaxTree },
            references,
            new(OutputKind.DynamicallyLinkedLibrary)
        );

        var generator = new AutomaticInterfaceGenerator();

        CSharpGeneratorDriver
            .Create(generator)
            .RunGeneratorsAndUpdateCompilation(
                compilation,
                out var outputCompilation,
                out var diagnostics
            );

        diagnostics.Where(d => d.Severity == DiagnosticSeverity.Error).Should().BeEmpty();

        return outputCompilation.SyntaxTrees.Skip(1).LastOrDefault()?.ToString();
    }

    [Fact]
    public void WorksWithOptionalParameters()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample;

            [GenerateAutomaticInterface]
            public class DemoClass
            {
                    public bool TryStartTransaction(
                        string file = "",
                        string member = "",
                        int line = 0)
                    {
            return true;
            }
            }


            """;
        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    bool TryStartTransaction(string file = "", string member = "", int line = 0);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void WorksWithOptionalStructParameters()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample;

            public struct MyStruct
            {
                private int Bar;
            }

            [GenerateAutomaticInterface]
            public class DemoClass
            {
                    public bool TryStartTransaction(MyStruct data = default(MyStruct))
                    {
            return true;
            }
            }


            """;
        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    bool TryStartTransaction(AutomaticInterfaceExample.MyStruct data = default(AutomaticInterfaceExample.MyStruct));
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void WorksWithOptionalNullParameters()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample;

            [GenerateAutomaticInterface]
            public class DemoClass
            {
                    public bool TryStartTransaction(string data = null)
                    {
            return true;
            }
            }


            """;
        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    bool TryStartTransaction(string data = null);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void GeneratesEmptyInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GenerateAutomaticInterface]
                class DemoClass
                {
                                 }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                }
            }

            """;

        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void GeneratesStringPropertyInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public string Hello { get; set; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; set; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void GeneratesStringPropertySetOnlyInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    private string x;
                    public string Hello { set => x = value; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { set; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void GeneratesStringPropertyGetOnlyInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    private string x;
                    public string Hello { get; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsUsingsToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public DirectoryInfo Hello { get; set; }
                                 }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    System.IO.DirectoryInfo Hello { get; set; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsPublicMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                              
                    public string Hello(){return "";}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello();
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsPublicTaskMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;
            using System.Threading.Tasks;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                   public async Task<string> Hello(){return "";}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;
            using System.Threading.Tasks;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    System.Threading.Tasks.Task<string> Hello();
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsPublicWithParamsMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                              
                    public string Hello(string x){return x;}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello(string x);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsPublicWithParamsGenericMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;
            using System.Threading.Tasks;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public string Hello(Task<string> x){return "";}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;
            using System.Threading.Tasks;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello(System.Threading.Tasks.Task<string> x);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsPublicWithMultipleParamsMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public string Hello(string x, int y, double z){return x;}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello(string x, int y, double z);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void IgnoresNotPublicMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    private string Hello(string x, int y, double z){return x;}
                    internal string Hello2(string x, int y, double z){return x;}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsDescriptionFromMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {

                    /// <summary>
                    /// TEST
                    /// </summary>
                    /// <returns></returns>
                    public string Hello(string x){return x;}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello(string x);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void AddsMultiLineDescriptionFromMethodToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {

                    /**
                     * <summary>Hello World!</summary>
                     */
                    public string Hello(string x){return x;}
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System.IO;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello(string x);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void OmitsPrivateSetPropertyInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    /// <inheritdoc />
                    public string Hello { get; private set; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void CopiesDocumentationOfPropertyToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                    public string Hello { get; private set; }
                                 }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void CopiesDocumentationOfClassToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public string Hello { get; private set; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void DoesNotCopyCtorToToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {
                    DemoClass(string x)
                    {

                    }

                    public string Hello { get; private set; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void DoesNotCopyStaticMethodsToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public static string Hello => "abc"; // property

                    public static string StaticMethod()  // method
                    {
                        return "static";
                   }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void MakesGenericInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass<T,U> where T:class
                {
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass<T,U> where T:class
                {
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void CopiesEventsToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {

                    /// <summary>
                    /// Bla bla
                    /// </summary>
                    public event EventHandler ShapeChanged;  // included

                    private event EventHandler ShapeChanged2; // ignored because not public
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    event System.EventHandler ShapeChanged;
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void DoesNotCopyIndexerToInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {

                    private int[] arr = new int[100];

                    /// <summary>
                    /// Bla bla
                    /// </summary>
                    public int this[int index] // currently ignored
                    {
                        get => arr[index];
                        set => arr[index] = value;
                    }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void FullExample()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {
                    /// <summary>
                    /// Property Documentation will be copied
                    /// </summary>
                    public string Hello { get; set; }  // included, get and set are copied to the interface when public

                    public string OnlyGet { get; } // included, get and set are copied to the interface when public

                    /// <summary>
                    /// Method Documentation will be copied
                    /// </summary>
                    public string AMethod(string x, string y) // included
                    {
                        return BMethod(x,y);
                    }

                    private string BMethod(string x, string y) // ignored because not public
                    {
                        return x + y;
                    }

                    public static string StaticProperty => "abc"; // static property, ignored

                    public static string StaticMethod()  // static method, ignored
                        {
                            return "static" + DateTime.Now;
                        }

                    /// <summary>
                    /// event Documentation will be copied
                    /// </summary>

                    public event EventHandler ShapeChanged;  // included

                    private event EventHandler ShapeChanged2; // ignored because not public

                    private readonly int[] arr = new int[100];

                    public int this[int index] // currently ignored
                    {
                        get => arr[index];
                        set => arr[index] = value;
                    }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; set; }
                    
                    /// <inheritdoc />
                    string OnlyGet { get; }
                    
                    /// <inheritdoc />
                    string AMethod(string x, string y);
                    
                    /// <inheritdoc />
                    event System.EventHandler ShapeChanged;
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void WorksWithFileScopedNamespace()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample;

            [GenerateAutomaticInterface]
            class DemoClass
            {
                public string Hello { get; set; }
            }


            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string Hello { get; set; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void WorksWithGenericMethods()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample;

            [GenerateAutomaticInterface]
            public class DemoClass
            {
                /// <inheritdoc />
                public string CMethod<T, T1, T2, T3, T4>(string x, string y)
                    where T : class
                    where T1 : struct
                    where T3 : DemoClass
                    where T4 : IDemoClass
                {
                    return "Ok";
                }
            }


            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string CMethod<T, T1, T2, T3, T4>(string x, string y) where T : class where T1 : struct where T3 : DemoClass where T4 : IDemoClass;
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void GeneratesOverloadedMethodInterface()
    {
        const string code = """

            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {

                [GenerateAutomaticInterface]
                class DemoClass
                {
                    public string AMethod(string x, string y)
                    {
                        return string.Empty;
                    }

                    public string AMethod(string x, string y, string crash)
                    {
                        return string.Empty;
                    }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string AMethod(string x, string y);
                    
                    /// <inheritdoc />
                    string AMethod(string x, string y, string crash);
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void WorksWithNullableContext()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            namespace AutomaticInterfaceExample;
            [GenerateAutomaticInterface]
            public class DemoClass
            {
                public string AMethod(DemoClass? x, string y)
                {
                    return "Ok";
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            #nullable enable
            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string AMethod(AutomaticInterfaceExample.DemoClass? x, string y);
                    
                }
            }
            #nullable restore

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void WorksWithNullableReturn()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            namespace AutomaticInterfaceExample;
            [GenerateAutomaticInterface]
            public class DemoClass
            {
                public string? AMethod(DemoClass x, string y)
                {
                    return "Ok";
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            #nullable enable
            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;

            namespace AutomaticInterfaceExample
            {
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string? AMethod(AutomaticInterfaceExample.DemoClass x, string y);
                    
                }
            }
            #nullable restore

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void NullableEvent()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {

                    /// <summary>
                    /// Bla bla
                    /// </summary>
                    public event EventHandler? ShapeChangedNullable;
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    event System.EventHandler? ShapeChangedNullable;
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void NullableProperty()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {

                    /// <summary>
                    /// Bla bla
                    /// </summary>
                    public string? NullableProperty { get; set; }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    string? NullableProperty { get; set; }
                    
                }
            }

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void BooleanWithNonNull()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                    /// <summary>
                    /// Bla bla
                    /// </summary>
                [GenerateAutomaticInterface]
                class DemoClass
                {

                   public async Task<Stream?> GetFinalDocumentsByIDFails(
                                   string agreementID, 
                                   string docType, 
                                   bool amt = false , 
                                   bool? attachSupportingDocuments = true, 
                                   CancellationToken cancellationToken = default)
                  {
                      await Task.Delay(100);
                      return default(Stream?);

                  }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            #nullable enable
            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    Task<Stream?> GetFinalDocumentsByIDFails(string agreementID, string docType, bool amt = False, bool? attachSupportingDocuments = True, CancellationToken cancellationToken = null);
                    
                }
            }
            #nullable restore

            """;
        GenerateCode(code).Should().Be(expected);
    }

    [Fact]
    public void CustomNameSpace()
    {
        const string code = """

            using AutomaticInterfaceAttribute;
            using System;

            namespace AutomaticInterfaceExample
            {
                [AttributeUsage(AttributeTargets.Class)]
                public class GenerateAutomaticInterfaceAttribute : Attribute
                {
                    public GenerateAutomaticInterfaceAttribute(string namespaceName = "") { }
                }

                /// <summary>
                /// Bla bla
                /// </summary>
                [GenerateAutomaticInterface("CustomNameSpace")]
                class DemoClass
                {

                   public async Task<Stream?> GetFinalDocumentsByIDFails(
                                   string agreementID, 
                                   string docType, 
                                   bool amt = false , 
                                   bool? attachSupportingDocuments = true, 
                                   CancellationToken cancellationToken = default)
                  {
                      await Task.Delay(100);
                      return default(Stream?);

                  }
                }
            }

            """;

        const string expected = """
            //--------------------------------------------------------------------------------------------------
            // <auto-generated>
            //     This code was generated by a tool.
            //
            //     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
            // </auto-generated>
            //--------------------------------------------------------------------------------------------------

            #nullable enable
            using System.CodeDom.Compiler;
            using AutomaticInterfaceAttribute;
            using System;

            namespace CustomNameSpace
            {
                /// <summary>
                /// Bla bla
                /// </summary>
                [GeneratedCode("AutomaticInterface", "")]
                public partial interface IDemoClass
                {
                    /// <inheritdoc />
                    Task<Stream?> GetFinalDocumentsByIDFails(string agreementID, string docType, bool amt = False, bool? attachSupportingDocuments = True, CancellationToken cancellationToken = null);
                    
                }
            }
            #nullable restore

            """;
        GenerateCode(code).Should().Be(expected);
    }
}
